<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"
        name="viewport" />
    <title>Vendor</title>
    <style>
        #draggable-box {
            width: 400px;
            height: 400px;
            background-color: lightblue;
            position: absolute;
            top: 50px;
            left: 600px;
            cursor: move;
            border-radius: 5px;
            border: 1px solid white;
        }

        #lastActiveUser {
            list-style-type: none;
            padding: 0;
            font-family: sans-serif;
        }

        .lastActiveUser_li {
            padding: 10px;
            background-color: #f0f0f0;
            margin-bottom: 5px;
            border-radius: 5px;
        }

        .tabs {
            display: flex;
        }

        .tab-button {
            padding: 12px 4px;
            background-color: #fff;
            color: black;
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex: 1;
            font-size: 12px;
            border: none;
        }

        .tab-button:hover {
            background-color: #ddd;
        }

        .tab-button:focus {
            outline: none;
            background-color: #ddd;
        }

        .tab-button.active {
            background-color: lightblue;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 0 12px 12px 12px;
            border-top: 1px solid white;
            border-radius: 0 0 5px 5px;
            overflow-y: scroll;
            height: 81%;
        }

        .tab-content.active {
            display: block;
        }

        .spacing {
            margin: 8px;
        }

        .loader {
            border: 16px solid #f3f3f3;
            /* Light grey */
            border-top: 16px solid #3498db;
            /* Blue */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            margin: auto;
            margin-top: 50px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="draggable-box">
        <div class="tabs"><button id="tab1" class="tab-button active">Active users</button> <button id="tab2"
                class="tab-button">Install Apk</button> <button id="tab3" class="tab-button">API Logger</button></div>
        <div class="tab-content active" id="tab-content1">
            <ul id="lastActiveUser"></ul>
        </div>
        <div class="tab-content" id="tab-content2">
            <br />
            <label class="spacing" for="inputField">Enter your Bitrise build number:</label>
            <input class="spacing" type="number" id="apkIntallerInput" name="inputField" placeholder="1396" required>
            <p class="spacing">Note: It may take upto 30 seconds, please have patience</p>
            <button class="spacing" id="apkIntallerInput-submit" onclick="installApk()">Submit</button>
            <p class="spacing" id="apkIntallerInput-responseText"></p>
            <div id="apkIntallerInput-loader" class="loader" style="display: none;"></div>
        </div>
        <div class="tab-content" id="tab-content3">
            <h1><a href="http://10.250.82.31:3000/network/" target="_blank">Click to open in new tab</a></h1>
        </div>
    </div>
</body>
<script>// Draggable container styles
    const draggableBox = document.getElementById('draggable-box');
    let offsetX, offsetY;
    let isDragging = false;
    draggableBox.addEventListener('mousedown', (event) => {
        isDragging = true;
        offsetX = event.clientX - draggableBox.getBoundingClientRect().left;
        offsetY = event.clientY - draggableBox.getBoundingClientRect().top;
    });
    document.addEventListener('mousemove', (event) => {
        if (isDragging) {
            const newX = event.clientX - offsetX;
            const newY = event.clientY - offsetY;
            draggableBox.style.left = `${newX}px`;
            draggableBox.style.top = `${newY}px`;
        }
    });
    document.addEventListener('mouseup', () => {
        isDragging = false;
    });

    // Tab handling
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    function handleClick(event) {
        // Remove active class from all tab buttons and tab contents
        tabButtons.forEach(button => button.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));

        // Add active class to the clicked tab button and corresponding tab content
        const tabId = event.target.id;
        document.getElementById(tabId).classList.add('active');
        document.getElementById(`tab-content${tabId.slice(-1)}`).classList.add('active');
    }
    tabButtons.forEach(button => button.addEventListener('click', handleClick));


    // Handle tabs functionality
    const timeLimitInMinutes = 1130;
    const sendPingToServer = async () => {
        const response = await fetch('http://10.250.82.31:3000/admin/ping/');
        return response
    }
    const getAllUsersPing = async () => {
        const response = await fetch(`http://10.250.82.31:3000/admin/getactiveusers?timeLimitInMinutes=${timeLimitInMinutes}`);
        const data = await response.json();
        return data
    }
    const installApk = async () => {
        try {
            const bitriseBuildNumber = document.getElementById('apkIntallerInput').value;
            if (bitriseBuildNumber) {
                document.getElementById('apkIntallerInput-loader').style.display = 'block';
                document.getElementById('apkIntallerInput-submit').style.display = 'none';
                const response = await fetch(`http://10.250.82.31:3000/admin/installapk/${bitriseBuildNumber}`);
                document.getElementById('apkIntallerInput-responseText').innerHTML = `Response - ${response.statusText} (${response.status})`;
            } else {
                throw new Error("Check value of input")
            }
        } catch (e) {
            console.error("error: ", e)
            document.getElementById('apkIntallerInput-responseText').innerHTML = e;
        }
        document.getElementById('apkIntallerInput-loader').style.display = 'none';
        document.getElementById('apkIntallerInput-submit').style.display = 'block';
    }

    const isTabFocused = () => {
        return !document.hidden;
    }

    const updateList = (items) => {
        const ul = document.getElementById('lastActiveUser');
        ul.innerHTML = '';
        items.forEach(item => {
            const li = document.createElement('li');
            li.classList.add('lastActiveUser_li');
            li.textContent = item;
            ul.appendChild(li);
        });
    }

    const alertMessage = (txt) => {
        return txt.endsWith("seconds ago") ? 'ðŸš¨ðŸ“¢' : ''
    }

    const main = () => {
        if (isTabFocused()) {
            sendPingToServer()
                .then(v => console.error("===> Ping to server: ", v))
                .catch(e => console.error("Ping Error: ", e));
            getAllUsersPing()
                .then(v => {
                    document.getElementById('tab1').innerHTML = `Active Users (${v.length})`
                    updateList(v.map(o => `${o.u} (${o.t}) ${alertMessage(o.t)}`))
                })
                .catch(e => console.error("Users Error: ", e));
        }
    }

    main();
    setInterval(main, 5000);</script>

</html>